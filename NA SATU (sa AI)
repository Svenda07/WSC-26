using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Data.SqlClient;

namespace WindowsFormsApp2
{
    public partial class Form1 : Form
    {
        SqlConnection cnn;
        public Form1()
        {
            InitializeComponent();
            
        }
        public class ListBoxItem
        {
            public int Id { get; set; }
            public string Text { get; set; }
            public override string ToString()
            {
                return $"{Id} - {Text}";
            }
        }
        private void button1_Click(object sender, EventArgs e)
        {
            
                string cs;             
            cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";
            using (cnn = new SqlConnection(cs))
            {
                cnn.Open();
                SqlCommand cmd = new SqlCommand("SELECT Id, naziv FROM Marka", cnn);
                SqlDataReader reader = cmd.ExecuteReader();
                listBox2.Items.Clear();

                while (reader.Read())
                {
                    int id = (int)reader["Id"];
                    string naziv = reader["naziv"].ToString();
                    
                    listBox2.Items.Add(new ListBoxItem { Id = id, Text = naziv });
                }
                reader.Close();
            }

        }

        private void button2_Click(object sender, EventArgs e)
        {
            listBox1.Items.Clear();
            string cs;
            cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";
            using (SqlConnection con = new SqlConnection(cs))
            {
                string query = @"SELECT V.Id, V.Naziv AS Vozilo, M.naziv AS Marka
                         FROM Vozila V
                         JOIN Marka M ON V.Marka = M.Id
                         WHERE V.aktivno = 1";
                SqlCommand cmd = new SqlCommand(query, con);
                con.Open();
                SqlDataReader reader = cmd.ExecuteReader();
                while (reader.Read())
                {
                    int id = (int)reader["Id"];
                    string vozilo = reader["Vozilo"].ToString();
                    string marka = reader["Marka"].ToString();
                    listBox1.Items.Add($"{id} - {vozilo} - {marka}");
                }
                reader.Close();
            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            string cs; 
            
            cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";
            if (textBox1.Text == "")
            {
                MessageBox.Show("Unesite naziv vozila.");
                return;
            }
            if (listBox2.SelectedItem == null)
            {
                MessageBox.Show("Odaberite marku.");
                return;
            }

            var selectedItem = (ListBoxItem)listBox2.SelectedItem;
            int markaId = selectedItem.Id;
            string nazivVozila = textBox1.Text;

            using (cnn = new SqlConnection(cs))
            {
                cnn.Open();
                string insert = "INSERT INTO Vozila (Naziv, Marka, aktivno) VALUES (@naziv, @marka, 1)";
                SqlCommand cmd = new SqlCommand(insert, cnn);
                cmd.Parameters.AddWithValue("@naziv", nazivVozila);
                cmd.Parameters.AddWithValue("@marka", markaId);
                cmd.ExecuteNonQuery();

                MessageBox.Show("Vozilo uspješno dodano.");
            }
            button2_Click(sender, e);
        }

        private void listBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null)
                return;

            var selectedItem = listBox1.SelectedItem.ToString();
            var parts = selectedItem.Split('-');
            int idVozila = int.Parse(parts[0].Trim());

            string cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";

            using (SqlConnection con = new SqlConnection(cs))
            {
                string query = "SELECT Naziv, Marka FROM Vozila WHERE Id=@id";
                SqlCommand cmd = new SqlCommand(query, con);
                cmd.Parameters.AddWithValue("@id", idVozila);
                con.Open();

                SqlDataReader reader = cmd.ExecuteReader();
                if (reader.Read())
                {
                    textBox1.Text = reader["Naziv"].ToString();
                    int markaId = (int)reader["Marka"];

                    

                    for (int i = 0; i < listBox2.Items.Count; i++)
                    {
                        var item = (ListBoxItem)listBox2.Items[i];
                        if (item.Id == markaId)
                        {
                            listBox2.SelectedIndex = i;
                            break;
                        }
                    }
                }
                reader.Close();
            }
        }

        private void button4_Click(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null)
            {
                MessageBox.Show("Odaberite vozilo za uređivanje.");
                return;
            }
            if (listBox2.SelectedItem == null)
            {
                MessageBox.Show("Odaberite marku.");
                return;
            }

            var selectedVozilo = listBox1.SelectedItem.ToString();
            var partsVozilo = selectedVozilo.Split('-');
            int idVozila = int.Parse(partsVozilo[0].Trim());

            var selectedMarka = (ListBoxItem)listBox2.SelectedItem;
            int markaId = selectedMarka.Id;
            string noviNaziv = textBox1.Text;

            string cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";

            using (SqlConnection con = new SqlConnection(cs))
            {
                string updateSql = "UPDATE Vozila SET Naziv=@Naziv, Marka=@Marka WHERE Id=@Id";
                SqlCommand cmd = new SqlCommand(updateSql, con);
                cmd.Parameters.AddWithValue("@Naziv", noviNaziv);
                cmd.Parameters.AddWithValue("@Marka", markaId);
                cmd.Parameters.AddWithValue("@Id", idVozila);
                con.Open();
                cmd.ExecuteNonQuery();
                MessageBox.Show("Vozilo je ažurirano");
            }

           
            button2_Click(sender, e);
        }

        private void button5_Click(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null)
            {
                MessageBox.Show("Odaberite vozilo za brisanje.");
                return;
            }

            var selectedVozilo = listBox1.SelectedItem.ToString();
            var parts = selectedVozilo.Split('-');
            int idVozila = int.Parse(parts[0].Trim());

            string cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";

            using (SqlConnection con = new SqlConnection(cs))
            {
                string updateSql = "UPDATE Vozila SET aktivno = 0 WHERE Id = @Id";
                SqlCommand cmd = new SqlCommand(updateSql, con);
                cmd.Parameters.AddWithValue("@Id", idVozila);
                con.Open();
                int rowsAffected = cmd.ExecuteNonQuery();
                if (rowsAffected > 0)
                    MessageBox.Show("Vozilo je označeno kao neaktivno (obrisano).");
                else
                    MessageBox.Show("Dogodila se greška pri brisanju vozila.");
            }

            
            button2_Click(sender, e);
        }

        private void button7_Click(object sender, EventArgs e)
        {
            if (listBox2.SelectedItem == null)
            {
                MessageBox.Show("Odaberite marku za promjenu.");
                return;
            }

            string noviNazivMarke = textBox2.Text.Trim();
            if (string.IsNullOrEmpty(noviNazivMarke))
            {
                MessageBox.Show("Unesite novi naziv marke.");
                return;
            }

            var selectedMarka = (ListBoxItem)listBox2.SelectedItem;
            int markaId = selectedMarka.Id;

            string cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";

            using (SqlConnection con = new SqlConnection(cs))
            {
                string updateSql = "UPDATE Marka SET naziv = @naziv WHERE Id = @id";
                SqlCommand cmd = new SqlCommand(updateSql, con);
                cmd.Parameters.AddWithValue("@naziv", noviNazivMarke);
                cmd.Parameters.AddWithValue("@id", markaId);
                con.Open();
                cmd.ExecuteNonQuery();
            }

            MessageBox.Show("Marka je uspješno ažurirana.");
            button1_Click(sender, e);  
            textBox2.Clear();
        }

        private void button6_Click(object sender, EventArgs e)
        {
            string novaMarka = textBox2.Text.Trim();

            if (string.IsNullOrEmpty(novaMarka))
            {
                MessageBox.Show("Unesite naziv marke.");
                return;
            }

            string cs = @"Data Source=localhost\sqlexpress;Initial Catalog=Ispit5.11.;User ID=4.RM;Password=123456789";

            using (SqlConnection con = new SqlConnection(cs))
            {
                con.Open();
                string insertSql = "INSERT INTO Marka (naziv) VALUES (@naziv)";
                SqlCommand cmd = new SqlCommand(insertSql, con);
                cmd.Parameters.AddWithValue("@naziv", novaMarka);
                cmd.ExecuteNonQuery();
            }

            MessageBox.Show("Nova marka je dodana.");
            button1_Click(sender, e);
            textBox2.Clear();
        }
    }
}
